<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RACE</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;800&family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f14;
  --panel: rgba(18,22,32,.42);
  --line: rgba(255,255,255,.16);
  --text: rgba(255,255,255,.95);
  --muted: rgba(255,255,255,.70);
  --accent:#ff3b3b;
  --good:#4cff9a;
  --shadow: rgba(0,0,0,.45);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  color:var(--text);
  font-family:"M PLUS Rounded 1c","Hiragino Maru Gothic ProN","Yu Gothic UI",system-ui,sans-serif;
  background:
    radial-gradient(1200px 700px at 40% 20%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(rgba(0,0,0,.18), rgba(0,0,0,.55)),
    url("race_bg.jpg") center/cover no-repeat fixed,
    var(--bg);
}

.wrap{
  max-width: 1100px;
  margin:0 auto;
  padding: 10px 10px 14px;
  min-height: 100dvh;
  display:flex;
  flex-direction:column;
  gap: 10px;
}

.header{
  background: var(--panel);
  border:1px solid var(--line);
  border-radius: 18px;
  padding: 10px 10px;
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 28px var(--shadow);
}

.topRow{
  display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
}

.brand{
  display:flex; align-items:center; gap:10px;
  min-width: 220px;
}
.brand .dot{
  width:12px; height:12px; border-radius:999px;
  background: var(--good);
  box-shadow: 0 0 14px rgba(76,255,154,.75);
}
.brandTitle{ display:flex; flex-direction:column; gap:2px; }
.brandTitle .t{
  font-weight: 900;
  letter-spacing:.06em;
  font-size: 15px;
  line-height:1.2;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}
.brandTitle .s{
  font-size: 11px; color: var(--muted);
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
  letter-spacing:.03em;
}

.controls{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
}

button{
  border-radius: 18px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.10);
  color: var(--text);
  padding: 10px 12px;
  min-height: 40px;
  font-weight: 900;
  letter-spacing:.04em;
  cursor:pointer;
  transition: transform .06s ease, background .15s ease;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}
button:hover{ background: rgba(255,255,255,.14); }
button:active{ transform: translateY(1px); }
button.primary{
  background: rgba(255,59,59,.22);
  border-color: rgba(255,59,59,.45);
}
button.primary:hover{ background: rgba(255,59,59,.30); }
button[disabled]{ opacity:.55; cursor:not-allowed; }

.hud{
  display:flex; gap:12px; flex-wrap:wrap; align-items:center;
  margin-top: 8px;
  padding: 0 2px;
  color: var(--muted);
  font-size: 12px;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}
.hud strong{ color: var(--text); font-weight: 900; }
.timer strong{ color: var(--accent); font-size: 14px; }

.pill{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.18);
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 12px;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}

/* Track */
.track{
  flex: 1 1 auto;
  min-height: 0;
  background: var(--panel);
  border:1px solid var(--line);
  border-radius: 20px;
  padding: 10px;
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 28px var(--shadow);
  display:flex;
  flex-direction:column;
}
.trackHead{
  display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  margin-bottom: 8px;
}
.trackHead .ttl{
  font-weight: 900;
  letter-spacing:.06em;
  font-size: 15px;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}

/* lanes: internal scroll */
.lanes{
  flex: 1 1 auto;
  min-height: 0;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  background: rgba(0,0,0,.12);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  padding: 8px;
}

.lane{
  display:grid;
  grid-template-columns: 180px 1fr;
  gap: 10px;
  align-items:center;
  padding: 2px 8px;
  margin: 2px 0;
  border-radius: 14px;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.07);
}
.lane:first-child{ margin-top:0; }
.lane:last-child{ margin-bottom:0; }

.bib{
  display:grid;
  grid-template-columns: 52px 1fr;
  column-gap: 10px;
  align-items:center;
}
.bib .no{
  width: 52px; height: 34px;
  border-radius: 14px;
  display:grid; place-items:center;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.20);
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
  font-weight:900;
}
.bib .nm{
  font-size: 13px;
  color: rgba(255,255,255,.92);
  white-space: nowrap;
  overflow: visible;
  text-overflow: clip;
  letter-spacing: .02em;
  font-family:"M PLUS Rounded 1c",system-ui,sans-serif;
  font-weight: 700;
}

.rail{
  position:relative;
  height: 42px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background:
    linear-gradient(90deg, rgba(255,255,255,.10) 0 2px, transparent 2px 10%,
                          rgba(255,255,255,.10) 10% 10.3%, transparent 10.3% 20%,
                          rgba(255,255,255,.10) 20% 20.3%, transparent 20.3% 30%,
                          rgba(255,255,255,.10) 30% 30.3%, transparent 30.3% 40%,
                          rgba(255,255,255,.10) 40% 40.3%, transparent 40.3% 50%,
                          rgba(255,255,255,.10) 50% 50.3%, transparent 50.3% 60%,
                          rgba(255,255,255,.10) 60% 60.3%, transparent 60.3% 70%,
                          rgba(255,255,255,.10) 70% 70.3%, transparent 70.3% 80%,
                          rgba(255,255,255,.10) 80% 80.3%, transparent 80.3% 90%,
                          rgba(255,255,255,.10) 90% 90.3%, transparent 90.3% 100%);
  overflow:hidden;
}
.finish{
  position:absolute; right: 12px; top: -7px; bottom:-7px;
  width: 9px;
  border-radius: 6px;
  background: repeating-linear-gradient(#fff 0 6px, rgba(0,0,0,.7) 6px 12px);
  box-shadow: 0 0 0 2px rgba(0,0,0,.25);
  opacity: .95;
}

.runner{
  position:absolute; left: 10px; top: 50%;
  width: 62px; height: 40px;
  transform: translate(0px, -50%);
  will-change: transform;
  pointer-events:none;
  --runDur: 0.16s;
}
.runner::before{
  content:"";
  position:absolute; left:-14px; top: 50%;
  width: 16px; height: 2px;
  background: rgba(255,255,255,.22);
  transform: translateY(-50%);
  border-radius: 999px;
  animation: streak var(--runDur) linear infinite;
  opacity:.22;
}
@keyframes streak{
  from{ transform: translate(-6px,-50%); opacity:.10; }
  to  { transform: translate(2px,-50%); opacity:.28; }
}

.horseImg{
  width: 62px; height: 40px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  overflow:hidden;
  position: relative;
  box-shadow: 0 6px 14px rgba(0,0,0,.22);
  transform-origin: 14px 24px;
  animation: horseBob var(--runDur) linear infinite;
}
.horseImg img{
  width:100%; height:100%;
  object-fit: cover;
  display:block;
  transform-origin: 18px 26px;
  animation: horseLean var(--runDur) linear infinite;
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.45));
}
@keyframes horseBob{
  0%   { transform: translateY(0px) rotate(-1deg); }
  50%  { transform: translateY(2px) rotate(-3deg); }
  100% { transform: translateY(0px) rotate(-1deg); }
}
@keyframes horseLean{
  0%   { transform: scaleX(1.02) rotate(-2deg); }
  50%  { transform: scaleX(0.98) rotate(-4deg); }
  100% { transform: scaleX(1.02) rotate(-2deg); }
}

/* Results panel */
.resultWrap{
  display:none;
  background: var(--panel);
  border:1px solid rgba(255,255,255,.18);
  border-radius: 18px;
  padding: 10px;
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 28px var(--shadow);
}
.resultWrap.show{ display:block; }
.resultHead{
  display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  margin-bottom: 8px;
}
.resultHead .ttl{
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
  font-weight:900;
  letter-spacing:.06em;
  font-size: 16px;
}
.resultList{ display:flex; flex-direction:column; gap:6px; }
.resultItem{
  display:grid;
  grid-template-columns: 64px 56px 1fr 92px;
  gap: 8px;
  align-items:center;
  padding: 8px 10px;
  border-radius: 16px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.10);
}
.badge{
  display:grid; place-items:center;
  height: 34px;
  border-radius: 12px;
  font-weight: 900;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.16);
}
.badge.rank1{ background: rgba(255,215,0,.18); border-color: rgba(255,215,0,.35); }
.badge.rank2{ background: rgba(192,192,192,.16); border-color: rgba(192,192,192,.32); }
.badge.rank3{ background: rgba(205,127,50,.16); border-color: rgba(205,127,50,.32); }
.miniNo{
  display:grid; place-items:center;
  height: 34px;
  border-radius: 12px;
  font-weight: 900;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
  background: rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.14);
}
.rname{ font-weight: 900; letter-spacing:.02em; }
.rtime{
  text-align:right;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
  font-weight: 900;
  color: rgba(255,255,255,.88);
}

/* overlay */
.overlayDon{
  position: fixed;
  inset: 0;
  display:none;
  place-items:center;
  pointer-events:none;
  background: radial-gradient(circle at center, rgba(255,59,59,.16), transparent 60%);
}
.overlayDon.show{ display:grid; animation: flash .60s ease-out forwards; }
@keyframes flash{
  from{ opacity:0; }
  40%{ opacity:1; }
  to{ opacity:0; }
}
.donText{
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
  font-weight: 900;
  letter-spacing:.06em;
  font-size: clamp(44px, 8.5vw, 92px);
  color: #fff;
  text-shadow: 0 10px 30px rgba(0,0,0,.55);
  transform: scale(.35);
  animation: don .60s cubic-bezier(.2,1.2,.2,1) forwards;
}
@keyframes don{
  0%{ transform: scale(.35) rotate(-6deg); }
  55%{ transform: scale(1.18) rotate(2deg); }
  100%{ transform: scale(1.0) rotate(0deg); }
}
.finishBounce{ animation: finishBounce .45s cubic-bezier(.2,1.3,.2,1) 1; }
@keyframes finishBounce{
  0%{ transform: translate(var(--tx,0px), var(--ty, -50%)) scale(1); }
  55%{ transform: translate(var(--tx,0px), calc(var(--ty,-50%) - 6px)) scale(1.10); }
  100%{ transform: translate(var(--tx,0px), var(--ty,-50%)) scale(1); }
}

/* Settings drawer */
.drawerBack{
  position: fixed; inset:0;
  background: rgba(0,0,0,.55);
  display:none;
  z-index: 50;
}
.drawerBack.show{ display:block; }
.drawer{
  position: fixed;
  right: 12px;
  top: 12px;
  bottom: 12px;
  width: min(420px, calc(100vw - 24px));
  background: rgba(18,22,32,.88);
  border: 1px solid rgba(255,255,255,.18);
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
  padding: 12px;
  transform: translateX(110%);
  transition: transform .22s ease;
  z-index: 60;
  backdrop-filter: blur(12px);
  overflow:auto;
  font-family:"M PLUS Rounded 1c",system-ui,sans-serif;
}
.drawer.show{ transform: translateX(0); }
.drawerHead{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom: 10px;
}
.drawerHead .ttl{
  font-weight: 900;
  letter-spacing:.06em;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}
.row{
  display:grid;
  grid-template-columns: 1fr 120px;
  gap: 10px;
  margin: 10px 0;
  align-items:end;
}
.row input, .row select{
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.20);
  color: var(--text);
  padding: 10px 10px;
  min-height: 40px;
  outline:none;
  width:100%;
  font-family:"M PLUS Rounded 1c",system-ui,sans-serif;
  font-weight: 700;
}
.label{
  font-size: 11px;
  color:var(--muted);
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}
.smallBtn{ padding: 9px 10px; min-height: 40px; }
.names{ margin-top: 12px; display:grid; grid-template-columns: 1fr; gap: 8px; }
.nameRow{ display:grid; grid-template-columns: 46px 1fr; gap: 10px; align-items:center; }
.nameRow .n{
  height: 40px;
  display:grid; place-items:center;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.20);
  font-weight: 900;
  font-family:"Baloo 2","M PLUS Rounded 1c",system-ui,sans-serif;
}

/* Mobile tweaks */
@media (max-width: 560px){
  .controls button{ padding: 10px 10px; }
  .lane{ grid-template-columns: 168px 1fr; }
  .resultItem{ grid-template-columns: 58px 52px 1fr 84px; }
}
</style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div class="topRow">
      <div class="brand">
        <div class="dot"></div>
        <div class="brandTitle">
          <div class="t" id="titleView">RACE SPRINT</div>
          <div class="s" id="subline">‚Äî</div>
        </div>
      </div>

      <div class="controls">
        <button class="primary" id="startBtn">START</button>
        <button id="reseedBtn">ÊäΩÈÅ∏</button>
        <button id="resetBtn">RESET</button>
        <button id="settingsBtn">Ë®≠ÂÆö</button>
      </div>
    </div>

    <div class="hud">
      <div class="timer">ÊÆã„ÇäÔºö<strong id="remain">15.0</strong>s</div>
      <div>ÂÖàÈ†≠Ôºö<strong id="leader">‚Äî</strong></div>
      <div class="pill"><span id="fieldLabel">10</span>È†≠ / <span id="durLabel">15</span>s</div>
      <div><strong id="statusPill">ÂæÖÊ©ü</strong></div>
    </div>
  </div>

  <div class="track">
    <div class="trackHead">
      <div class="ttl">„É¨„Éº„Çπ</div>
    </div>
    <div class="lanes" id="lanes"></div>
  </div>

  <div class="resultWrap" id="resultWrap">
    <div class="resultHead">
      <div class="ttl">ÁùÄÈ†ÜÁ¢∫ÂÆöÔºÅ</div>
      <!-- ‚òÖÊó•ÊôÇ„ÉªÊôÇÈñì„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºöÈ†≠Êï∞/ÁßíÊï∞„Å†„Åë -->
      <div class="pill" id="resultMeta"></div>
    </div>
    <div class="resultList" id="resultList"></div>
  </div>

</div>

<div class="overlayDon" id="overlayDon"><div class="donText">ÁµêÊûúÁô∫Ë°®ÔºÅ</div></div>

<div class="drawerBack" id="drawerBack"></div>
<div class="drawer" id="drawer">
  <div class="drawerHead">
    <div class="ttl">Ë®≠ÂÆö</div>
    <button class="smallBtn" id="closeDrawerBtn">Èñâ„Åò„Çã</button>
  </div>

  <div class="row">
    <div class="field">
      <div class="label">„Çø„Ç§„Éà„É´Ôºà‰øùÂ≠òÔºâ</div>
      <input id="titleInput" placeholder="‰æãÔºöÈ¶¨ÂøçËÄÖ„Çπ„Éó„É™„É≥„ÉàÊùØ" />
    </div>
    <div class="field">
      <div class="label">È†≠Êï∞</div>
      <select id="fieldSize">
        <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option selected>10</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="field">
      <div class="label">ÁßíÊï∞</div>
      <select id="duration">
        <option value="10">10</option>
        <option value="12">12</option>
        <option value="15" selected>15</option>
        <option value="20">20</option>
      </select>
    </div>
    <div class="field">
      <div class="label">„Ç¢„Ç§„Ç≥„É≥</div>
      <button class="smallBtn" id="reloadIconBtn">ÂÜçË™≠Ëæº</button>
    </div>
  </div>

  <div class="label" style="margin-top:8px;">È¶¨ÂêçÔºà‰øùÂ≠òÔºâ</div>
  <div class="names" id="nameGrid"></div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const STORE_KEY = "race_showcase_clean_mobile_v2";
  const ICON_FILE = "horse_icon.png";
  const MIN_N = 5, MAX_N = 10;
  const FPS = 60;

  let N = 10;
  let RACE_SECONDS = 15.0;
  let STEPS = Math.floor(RACE_SECONDS * FPS);

  let running = false;
  let rafId = null;
  let t0 = null;

  let runners = [];

  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const rand = ()=>Math.random();
  const randInt = (a,b)=>Math.floor(rand()*(b-a+1))+a;

  function escapeHtml(s){
    return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
            .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function loadStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){ return null; }
  }
  function saveStore(){
    const data = { n:N, dur:RACE_SECONDS, title:$("titleInput").value || "", names:getNames() };
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(data)); }catch(e){}
  }

  function defaultName(i){
    const A = ["ÁñæËµ∞","ÂΩ±Ëµ∞","ÂøçÈ¢®","ÈªíÂΩ±","ÊúàÂÖâ","ÈõªÂÖâ","ÈâÑÂ£Å","ÁÉàÁÅ´","ÁôΩÂàÉ","ËíºÂ§©"];
    const B = ["„Éé„ÉØ„Éº„É´","„Ç´„Çø„É©„Éº„Éä","„Éï„É©„ÉÉ„Ç∞","„É¢„É´„ÉÉ„ÇØ","„Éó„É™„É≥","„Éë„ÇØ„ÉÅ„Éº","„Ç≤„Éº„Éà","„Çø„ÉØ„Éº","„Çµ„É¢„Ç¢","„Çπ„Éó„É™„É≥„Éà"];
    return `${A[i%10]}${B[randInt(0,9)]}`;
  }

  function setTitleUI(v){
    const title = (v && v.trim()) ? v.trim() : "RACE SPRINT";
    $("titleView").textContent = title;
    document.title = title;
  }
  function setSubline(){
    $("subline").textContent = `${N}È†≠ / ${RACE_SECONDS.toFixed(0)}s`;
    $("fieldLabel").textContent = String(N);
    $("durLabel").textContent = String(RACE_SECONDS.toFixed(0));
  }

  function buildNameInputs(namesFromStore){
    const grid = $("nameGrid");
    grid.innerHTML = "";
    for(let i=0;i<N;i++){
      const row = document.createElement("div");
      row.className = "nameRow";
      row.innerHTML = `<div class="n">${i+1}</div><input placeholder="È¶¨Âêç" />`;
      grid.appendChild(row);

      const inp = row.querySelector("input");
      inp.value = (namesFromStore && namesFromStore[i]) ? namesFromStore[i] : defaultName(i);

      inp.addEventListener("input", () => {
        if (runners[i]) runners[i].nameEl.textContent = inp.value.trim() || `È¶¨${i+1}`;
        saveStore();
      });
    }
  }

  function getNames(){
    return [...$("nameGrid").querySelectorAll("input")]
      .map((inp, i) => inp.value.trim() || `È¶¨${i+1}`);
  }

  let iconCb = Date.now();
  function iconSrc(){ return `${ICON_FILE}?cb=${iconCb}`; }

  function runnerInner(){
    const src = iconSrc();
    return `
      <div class="horseImg">
        <img alt="" src="${src}"
          onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<?xml version=%221.0%22?><svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2262%22 height=%2240%22><rect width=%2262%22 height=%2240%22 rx=%2212%22 fill=%22%23111%22/><text x=%2231%22 y=%2226%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2216%22 fill=%22%23fff%22>üêé</text></svg>';">
      </div>
    `;
  }

  function buildLanes(){
    const lanes = $("lanes");
    lanes.innerHTML = "";
    runners = [];
    const names = getNames();

    for(let i=0;i<N;i++){
      const lane = document.createElement("div");
      lane.className = "lane";
      lane.innerHTML = `
        <div class="bib">
          <div class="no">${i+1}</div>
          <div class="nm">${escapeHtml(names[i] || `È¶¨${i+1}`)}</div>
        </div>
        <div class="rail">
          <div class="finish"></div>
          <div class="runner">${runnerInner()}</div>
        </div>
      `;
      lanes.appendChild(lane);

      runners.push({
        nameEl: lane.querySelector(".bib .nm"),
        railEl: lane.querySelector(".rail"),
        runnerEl: lane.querySelector(".runner"),
        series: null,
        lastX: 0,
        finishFrame: STEPS,
        finishTimeSec: null
      });
    }
  }

  function smoothNoise(seed){
    const knots = 22;
    const vals = Array.from({length:knots}, (_,k) => {
      const r = Math.sin((k+1)*911 + seed*137.9) * 43758.5453;
      return (r - Math.floor(r));
    });
    const out = new Float32Array(STEPS+1);
    const smoothstep = (t)=>t*t*(3-2*t);
    const lerp=(a,b,t)=>a+(b-a)*t;
    for(let s=0;s<=STEPS;s++){
      const u = s / STEPS * (knots-1);
      const i = Math.floor(u);
      const f = smoothstep(u - i);
      out[s] = lerp(vals[i], vals[Math.min(knots-1, i+1)], f);
    }
    return out;
  }
  function pulse(p,a,b){
    if (p < a || p > b) return 0;
    const t = (p - a) / (b - a);
    return Math.sin(t * Math.PI);
  }

  function generateRaceSeries(){
    const finishFrames = [];
    const baseEnd = STEPS;
    const minEnd = Math.floor(STEPS * 0.94);
    for(let i=0;i<N;i++) finishFrames.push(randInt(minEnd, baseEnd));
    finishFrames.sort((a,b)=>a-b);
    finishFrames[finishFrames.length-1] = baseEnd;

    const perm = [...Array(N).keys()].sort(()=>Math.random()-0.5);
    const horseFinishFrame = Array(N).fill(STEPS);
    for(let rank=0; rank<N; rank++){
      horseFinishFrame[perm[rank]] = finishFrames[rank];
    }

    const midPeak  = Array.from({length:N}, () => 0.38 + rand()*0.24);
    const latePeak = Array.from({length:N}, () => 0.78 + rand()*0.14);
    const baseSkill = Array.from({length:N}, () => 0.97 + rand()*0.06);

    const raw = Array.from({length:N}, () => new Float32Array(STEPS+1));

    for(let i=0;i<N;i++){
      const nz = smoothNoise(i+1);
      let x = 0;

      const midAmp  = 0.020 + rand()*0.020;
      const lateAmp = 0.020 + rand()*0.028;
      const wobbleAmp = 0.012;

      for(let s=0;s<=STEPS;s++){
        const p = s / STEPS;

        const base = 0.032 * baseSkill[i];
        const wobble = (nz[s]-0.5) * wobbleAmp;

        const mid  = pulse(p, midPeak[i]-0.18, midPeak[i]+0.18) * midAmp;
        const late = pulse(p, latePeak[i]-0.12, latePeak[i]+0.10) * lateAmp;

        const pack = (p < 0.70) ? 0.006 : 0.003;
        const v = clamp(base + wobble + mid + late + (rand()-0.5)*pack, 0.010, 0.110);
        x += v;
        raw[i][s] = x;
      }
    }

    for(let s=0;s<=STEPS;s++){
      let avg = 0;
      for(let i=0;i<N;i++) avg += raw[i][s];
      avg /= N;

      const p = s / STEPS;
      const k = (p < 0.72) ? 0.010 : 0.004;
      for(let i=0;i<N;i++){
        const diff = raw[i][s] - avg;
        raw[i][s] -= diff * k;
      }
    }

    for(let i=0;i<N;i++){
      const f = horseFinishFrame[i];
      const denom = raw[i][f];

      const series = new Float32Array(STEPS+1);
      for(let s=0;s<=STEPS;s++){
        if (s <= f) series[s] = clamp(raw[i][s] / denom, 0, 1.0);
        else series[s] = 1.0;
      }

      runners[i].series = series;
      runners[i].finishFrame = f;
      runners[i].finishTimeSec = null;
      runners[i].lastX = 0;
    }
  }

  function setStatus(text){ $("statusPill").textContent = text; }

  function stopRace(){
    running = false;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    $("startBtn").disabled = false;
    $("reseedBtn").disabled = false;
    $("resetBtn").disabled = false;
    $("settingsBtn").disabled = false;
    $("fieldSize").disabled = false;
    $("duration").disabled = false;
  }

  function updateUIAt(step, elapsedSec){
    let bestI = 0;
    let bestX = -1;

    for(let i=0;i<N;i++){
      const r = runners[i];
      const x = r.series ? r.series[step] : 0;

      if (r.finishTimeSec === null && x >= 1.0) r.finishTimeSec = elapsedSec;

      const railW = r.railEl.clientWidth;
      const runnerW = r.runnerEl.clientWidth;

      const leftPad = 10;
      const finishPad = 12 + 10;
      const maxX = Math.max(leftPad, railW - runnerW - finishPad);
      const px = leftPad + (maxX - leftPad) * x;

      const jiggle = Math.sin((step/5) + i*0.7) * 1.0;
      r.runnerEl.style.setProperty("--tx", px + "px");
      r.runnerEl.style.setProperty("--ty", "calc(-50% + " + jiggle + "px)");
      r.runnerEl.style.transform = `translate(${px}px, calc(-50% + ${jiggle}px))`;

      const dx = x - r.lastX;
      r.lastX = x;

      const spd = clamp(dx * 85, 0.2, 2.2);
      const runDur = clamp(0.22 - spd*0.065, 0.10, 0.22);
      r.runnerEl.style.setProperty("--runDur", runDur.toFixed(3) + "s");

      if (x > bestX){ bestX = x; bestI = i; }
    }

    const names = getNames();
    $("leader").textContent = `#${bestI+1} ${names[bestI]}`;
  }

  function showResultOverlay(){
    const ov = $("overlayDon");
    ov.classList.add("show");

    document.querySelectorAll(".runner").forEach(el => {
      el.classList.remove("finishBounce");
      void el.offsetWidth;
      el.classList.add("finishBounce");
      setTimeout(()=>el.classList.remove("finishBounce"), 520);
    });

    setTimeout(()=>ov.classList.remove("show"), 700);
  }

  function buildResultPanel(){
    const names = getNames();
    const arr = [...Array(N).keys()].map(i => ({ i, t: runners[i].finishTimeSec ?? (RACE_SECONDS + 999) }));
    arr.sort((a,b) => (a.t - b.t) || (a.i - b.i));

    // ‚òÖÊó•ÊôÇ„ÅØ‰∏ÄÂàáÂá∫„Åï„Å™„ÅÑÔºöÈ†≠Êï∞/ÁßíÊï∞„Å†„Åë
    $("resultMeta").textContent = `${N}È†≠ / ${RACE_SECONDS.toFixed(0)}Áßí`;

    const list = $("resultList");
    list.innerHTML = "";

    for(let rank=0; rank<arr.length; rank++){
      const i = arr[rank].i;
      const t = arr[rank].t;

      const item = document.createElement("div");
      item.className = "resultItem";

      const badgeCls = (rank===0) ? "badge rank1" : (rank===1 ? "badge rank2" : (rank===2 ? "badge rank3" : "badge"));
      item.innerHTML = `
        <div class="${badgeCls}">${rank+1}ÁùÄ</div>
        <div class="miniNo">#${i+1}</div>
        <div class="rname">${escapeHtml(names[i])}</div>
        <div class="rtime">${t.toFixed(2)}s</div>
      `;
      list.appendChild(item);
    }

    $("resultWrap").classList.add("show");
    $("resultWrap").scrollIntoView({behavior:"smooth", block:"start"});
    return arr[0].i;
  }

  function startRace(){
    if (running) return;

    $("resultWrap").classList.remove("show");

    buildLanes();
    generateRaceSeries();

    running = true;
    $("startBtn").disabled = true;
    $("reseedBtn").disabled = true;
    $("resetBtn").disabled = true;
    $("settingsBtn").disabled = true;
    $("fieldSize").disabled = true;
    $("duration").disabled = true;

    setStatus("Ëµ∞Ë°å‰∏≠");
    t0 = performance.now();

    const tick = (now) => {
      const elapsed = (now - t0) / 1000;
      const remain = Math.max(0, RACE_SECONDS - elapsed);
      $("remain").textContent = remain.toFixed(1);

      const step = Math.min(STEPS, Math.floor((elapsed / RACE_SECONDS) * STEPS));
      updateUIAt(step, elapsed);

      if (elapsed < RACE_SECONDS){
        rafId = requestAnimationFrame(tick);
      } else {
        finishRace();
      }
    };
    rafId = requestAnimationFrame(tick);
  }

  function finishRace(){
    for (let i=0;i<N;i++){
      if (runners[i].finishTimeSec === null) runners[i].finishTimeSec = RACE_SECONDS;
    }

    stopRace();
    $("remain").textContent = "0.0";
    updateUIAt(STEPS, RACE_SECONDS);

    showResultOverlay();
    const winner = buildResultPanel();

    const names = getNames();
    setStatus(`Á¢∫ÂÆöÔºö#${winner+1} ${names[winner]}`);
  }

  function reseed(){
    if (running) return;
    buildLanes();
    $("resultWrap").classList.remove("show");
    $("leader").textContent = "‚Äî";
    $("remain").textContent = RACE_SECONDS.toFixed(1);
    setStatus("ÂæÖÊ©ü");
  }

  function resetAll(){
    if (running) return;
    buildLanes();
    $("resultWrap").classList.remove("show");
    $("leader").textContent = "‚Äî";
    $("remain").textContent = RACE_SECONDS.toFixed(1);
    setStatus("ÂæÖÊ©ü");
  }

  function applyN(n, storedNames){
    N = clamp(n, MIN_N, MAX_N);
    $("fieldSize").value = String(N);
    buildNameInputs(storedNames);
    setSubline();
    buildLanes();
    saveStore();
  }

  function applyDuration(sec){
    RACE_SECONDS = sec;
    $("duration").value = String(sec);
    $("remain").textContent = sec.toFixed(1);
    STEPS = Math.floor(RACE_SECONDS * FPS);
    setSubline();
    saveStore();
  }

  function openDrawer(){
    $("drawerBack").classList.add("show");
    $("drawer").classList.add("show");
  }
  function closeDrawer(){
    $("drawerBack").classList.remove("show");
    $("drawer").classList.remove("show");
  }

  $("startBtn").addEventListener("click", () => { saveStore(); closeDrawer(); startRace(); });
  $("reseedBtn").addEventListener("click", () => { closeDrawer(); reseed(); });
  $("resetBtn").addEventListener("click", () => { closeDrawer(); resetAll(); });

  $("settingsBtn").addEventListener("click", () => openDrawer());
  $("closeDrawerBtn").addEventListener("click", () => closeDrawer());
  $("drawerBack").addEventListener("click", () => closeDrawer());

  $("fieldSize").addEventListener("change", (e) => {
    if (running) return;
    applyN(parseInt(e.target.value,10), getNames());
  });

  $("duration").addEventListener("change", (e) => {
    if (running) return;
    applyDuration(parseFloat(e.target.value));
  });

  $("titleInput").addEventListener("input", (e) => {
    setTitleUI(e.target.value || "");
    saveStore();
  });

  $("reloadIconBtn").addEventListener("click", () => {
    if (running) return;
    iconCb = Date.now();
    buildLanes();
  });

  const store = loadStore();
  const initN = store?.n ?? 10;
  const initDur = store?.dur ?? 15;
  const initTitle = store?.title ?? "RACE SPRINT";
  const initNames = store?.names ?? null;

  $("titleInput").value = initTitle;
  setTitleUI(initTitle);

  applyDuration(parseFloat(initDur));
  applyN(parseInt(initN,10), initNames);

  setStatus("ÂæÖÊ©ü");
  $("leader").textContent = "‚Äî";
  setSubline();

  saveStore();
})();
</script>
</body>
</html>

